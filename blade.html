<!DOCTYPE html>
<html lang="en">
<head>
    @php
        // Initialize variables
        $firstSceneUrl = null;
        if (isset($scenes) && $scenes && $scenes->isNotEmpty()) {
            $firstScene = $scenes->first();
            $firstSceneUrl = url(Storage::url($firstScene->image_path));
        }
        $csrfToken = csrf_token();
    @endphp
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virtual 360Â° Editor - {{ $virtualTour->title }}</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css">
    <meta name="csrf-token" content="{{ $csrfToken }}">
    
    <!-- Hidden debug status element for JavaScript compatibility -->
    <div id="debugStatus" style="display: none;">Status: Initializing...</div>
    
    <!-- Add a Debug Panel for Hotspots -->
    <div id="hotspotDebugPanel" style="position: fixed; right: 10px; bottom: 10px; background: rgba(0,0,0,0.8); color: white; padding: 10px; z-index: 1000; font-family: monospace; max-width: 400px; max-height: 300px; overflow: auto; display: none;">
        <div class="flex justify-between items-center mb-2">
            <div class="text-sm font-bold">Hotspot Debug</div>
            <button onclick="toggleHotspotDebug()" class="text-xs bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded">Hide</button>
        </div>
        <div id="hotspotDebugContent" class="text-xs"></div>
    </div>

    <style>
        /* Modern UI Styles */
        :root {
            --primary: #3b82f6;
            --primary-hover: #2563eb;
            --success: #10b981;
            --success-hover: #059669;
            --background: #0f172a;
            --foreground: #f8fafc;
            --muted: #1e293b;
            --muted-foreground: #94a3b8;
            --border: #334155;
            --card: #1e293b;
            --danger: #ef4444;
            --danger-hover: #dc2626;
        }

        body {
            background-color: var(--background);
            color: var(--foreground);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        /* Toolbar Styles */
        .toolbar {
            height: 56px;
            border-bottom: 1px solid var(--border);
            background-color: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(8px);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 50;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1rem;
        }

        .toolbar-button {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            transition: all 0.2s;
            background-color: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
        }

        .toolbar-button:hover {
            background-color: var(--primary-hover);
        }

        .toolbar-button.danger {
            background-color: var(--danger);
        }

        .toolbar-button.danger:hover {
            background-color: var(--danger-hover);
        }

        .toolbar-button svg, .toolbar-button i {
            width: 1rem;
            height: 1rem;
        }

        /* Main Layout */
        .editor-container {
            display: flex;
            height: 100vh;
            padding-top: 56px;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 300px;
            border-right: 1px solid var(--border);
            background-color: var(--card);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .scene-list {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        .scene-item {
            padding: 0.75rem;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 0.5rem;
            background-color: var(--muted);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .scene-item:hover {
            background-color: var(--primary);
        }

        .scene-item.active {
            background-color: var(--primary);
            border-left: 3px solid var(--success);
        }

        .scene-item-title {
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
        }

        .scene-item-actions {
            display: flex;
            gap: 0.5rem;
        }

        .scene-item-button {
            background: none;
            border: none;
            color: var(--muted-foreground);
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 0.25rem;
            transition: all 0.2s;
        }

        .scene-item-button:hover {
            color: var(--foreground);
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* Viewer Styles */
        .viewer-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: var(--background);
            position: relative;
        }

        .viewer-header {
            padding: 0.5rem 1rem;
            background-color: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(4px);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 10;
        }

        .viewer {
            flex: 1;
            position: relative;
        }

        .viewer-controls {
            position: absolute;
            bottom: 1rem;
            right: 1rem;
            display: flex;
            gap: 0.5rem;
            z-index: 10;
        }

        .control-button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(4px);
            border: 1px solid var(--border);
            color: var(--foreground);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .control-button:hover {
            background-color: var(--primary);
            border-color: var(--primary);
        }

        /* Hotspot Styles */
        .hotspot {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.8);
            cursor: move;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--primary);
        }

        .hotspot:hover {
            transform: scale(1.2);
            background: var(--primary);
        }

        .hotspot svg {
            width: 20px;
            height: 20px;
            color: var(--primary);
        }

        .hotspot:hover svg {
            color: white;
        }
        
        /* Custom hotspot styles for Pannellum */
        .custom-hotspot {
            width: 32px !important;
            height: 32px !important;
            margin-left: -16px !important;
            margin-top: -16px !important;
            background-color: rgba(255, 255, 255, 0.8) !important;
            border: 2px solid #3b82f6 !important;
            border-radius: 50% !important;
            cursor: pointer !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            transition: all 0.2s ease !important;
            position: absolute !important;
            transform-origin: center center !important;
        }
        
        .custom-hotspot:hover {
            transform: scale(1.2);
            background-color: #3b82f6 !important;
            border-color: white !important;
        }
        
        .custom-hotspot::before {
            content: '';
            width: 8px;
            height: 8px;
            background-color: #3b82f6;
            border-radius: 50%;
        }
        
        .custom-hotspot:hover::before {
            background-color: white;
        }
        
        .custom-hotspot.info {
            border-color: #10b981 !important;
        }
        
        .custom-hotspot.info svg {
            color: #10b981 !important;
        }
        
        .custom-hotspot.navigation {
            border-color: #3b82f6 !important;
        }
        
        .custom-hotspot.navigation svg {
            color: #3b82f6 !important;
        }

        /* Dialog Styles */
        .dialog-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .dialog {
            background-color: var(--card);
            border-radius: 0.5rem;
            padding: 1.5rem;
            width: 100%;
            max-width: 28rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            color: var(--foreground);
        }

        .dialog-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .dialog-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 0.375rem;
            background-color: var(--muted);
            color: var(--foreground);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(0, 120, 255, 0.1);
        }

        .hidden {
            display: none;
        }

        /* Loading indicator */
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top: 4px solid var(--primary);
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--card);
            color: var(--foreground);
            padding: 0.75rem 1.5rem;
            border-radius: 0.375rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        .toast.show {
            opacity: 1;
        }

        .toast.success {
            border-left: 3px solid var(--success);
        }

        .toast.error {
            border-left: 3px solid var(--danger);
        }

        /* Right sidebar */
        .right-sidebar {
            width: 300px;
            border-left: 1px solid var(--border);
            background-color: var(--card);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .right-sidebar-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .hotspot-list {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        .hotspot-item {
            padding: 0.75rem;
            border-radius: 0.375rem;
            margin-bottom: 0.5rem;
            background-color: var(--muted);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .hotspot-item-info {
            flex: 1;
            overflow: hidden;
        }

        .hotspot-item-title {
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .hotspot-item-type {
            font-size: 0.75rem;
            color: var(--muted-foreground);
        }

        .hotspot-item-actions {
            display: flex;
            gap: 0.5rem;
        }

        .hotspot-item-button {
            background: none;
            border: none;
            color: var(--muted-foreground);
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 0.25rem;
            transition: all 0.2s;
        }

        .hotspot-item-button:hover {
            color: var(--foreground);
            background-color: rgba(255, 255, 255, 0.1);
        }

        .hotspot-item-button.edit:hover {
            color: var(--primary);
        }

        .hotspot-item-button.delete:hover {
            color: var(--danger);
        }

        /* Empty state */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            text-align: center;
            color: var(--muted-foreground);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: var(--primary);
        }

        .empty-state-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .empty-state-description {
            margin-bottom: 1.5rem;
        }

        .hotspot-tooltip {
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
        }

        /* Improved hotspot styling */
        .custom-hotspot {
            width: 32px !important;
            height: 32px !important;
            margin-left: -16px !important;
            margin-top: -16px !important;
            border-radius: 50% !important;
            cursor: pointer !important;
            transform-origin: center center !important;
            background-color: rgba(255, 255, 255, 0.8) !important;
            border: 2px solid #3b82f6 !important;
            transition: all 0.3s ease !important;
        }

        .custom-hotspot.navigation {
            background-color: rgba(59, 130, 246, 0.9) !important;
            border-color: white !important;
        }

        .custom-hotspot:hover {
            transform: scale(1.2) !important;
        }

        .hotspot-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(-10px);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 14px;
            white-space: nowrap;
            pointer-events: none;
            z-index: 101;
            margin-bottom: 5px;
        }

        /* Dialog styling improvements */
        .dialog-overlay {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }

        .animate-spin {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>
<body>
    <!-- Add virtual tour ID input -->
    <div id="editor" data-tour-id="{{ $virtualTour->id }}" class="h-full">
        <!-- Top Toolbar -->
        <header class="toolbar">
            <div class="flex items-center space-x-4">
                <a href="{{ route('agent.virtual-360.index') }}" class="toolbar-button">
                    <i class="fas fa-arrow-left"></i>
                    Exit Editor
                </a>
                <h1 class="text-xl font-semibold">{{ $virtualTour->title ?? 'Untitled Tour' }}</h1>
            </div>
            <div class="flex items-center space-x-2">
                <a href="{{ route('agent.virtual-360.view-tour', $virtualTour) }}" class="toolbar-button" target="_blank">
                    <i class="fas fa-eye"></i>
                    View Tour
                </a>
                <div class="flex items-center space-x-2">
                    <button id="saveBtn" class="toolbar-button">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                    <button id="exportBtn" class="toolbar-button" onclick="exportTour()">
                        <i class="fas fa-file-export"></i> Export for Offline
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Editor Container -->
        <div class="editor-container">
            <!-- Left Sidebar - Scene List -->
            <div class="sidebar">
                <div class="sidebar-header">
                    <h2 class="sidebar-title">Scenes</h2>
                    <span class="text-sm text-muted-foreground">{{ $scenes->count() }}/20</span>
                </div>
                
                <div class="scene-list">
                    @if($scenes->isEmpty())
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i class="fas fa-images"></i>
                        </div>
                        <div class="empty-state-title">No Scenes Yet</div>
                        <div class="empty-state-description">
                            Upload your first 360Â° scene to get started
                        </div>
                    </div>
                    @else
                        @foreach($scenes as $scene)
                        <div class="scene-item {{ $loop->first ? 'active' : '' }}" 
                             data-scene-id="{{ $scene->id }}"
                             data-scene-url="{{ url(Storage::url($scene->image_path)) }}"
                             onclick="loadScene('{{ url(Storage::url($scene->image_path)) }}')">
                            <div class="scene-item-title">{{ $scene->title }}</div>
                            <div class="scene-item-actions">
                                <button class="scene-item-button" onclick="editScene({{ $scene->id }})" title="Edit Scene">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="scene-item-button" onclick="deleteScene({{ $scene->id }})" title="Delete Scene">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        @endforeach
                    @endif
                </div>
                
                <div class="p-4 border-t border-border">
                    <label class="block">
                        <span class="sr-only">Upload Scene</span>
                        <div class="flex items-center justify-center w-full">
                            <label for="scene-upload" class="flex flex-col items-center justify-center w-full h-24 border-2 border-dashed rounded-lg cursor-pointer bg-muted hover:bg-muted/80">
                                <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                    <i class="fas fa-cloud-upload-alt text-3xl mb-2 text-muted-foreground"></i>
                                    <p class="mb-2 text-sm text-muted-foreground">
                                        <span class="font-semibold">Click to upload</span> or drag and drop
                                    </p>
                                    <p class="text-xs text-muted-foreground">360Â° Image (JPG, PNG)</p>
                                </div>
                                <input id="scene-upload" type="file" class="hidden" accept="image/jpeg,image/png" onchange="handleUploadScene(event)" {{ $scenes->count() >= 20 ? 'disabled' : '' }}/>
                            </label>
                        </div>
                    </label>
                </div>
            </div>

            <!-- Main Content - Scene Editor -->
            <div class="viewer-container">
                <!-- Scene Viewer -->
                <div class="viewer">
                    <!-- Loading Indicator -->
                    <div id="loading" class="loading hidden">
                        <div class="loading-spinner"></div>
                        <div class="text-muted-foreground">Loading scene...</div>
                    </div>
                    
                    <!-- 360Â° Viewer -->
                    <div id="viewer" class="w-full h-full"></div>
                    
                    <!-- Viewer Controls -->
                    <div class="viewer-header">
                        <h2 class="text-lg font-semibold">{{ $firstScene->title ?? 'Select a Scene' }}</h2>
                        <div class="flex space-x-2">
                            <button class="toolbar-button" onclick="toggleAutoRotate()" title="Toggle Auto-Rotation">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                            <button class="toolbar-button" onclick="toggleFullscreen()" title="Toggle Fullscreen">
                                <i class="fas fa-expand"></i>
                            </button>
                            <button class="toolbar-button" onclick="toggleHotspotPlacement()" title="Click to Place Hotspot">
                                <i class="fas fa-crosshairs"></i>
                                Place Hotspot
                            </button>
                            <button class="toolbar-button" onclick="showAddHotspotDialog()" title="Add Hotspot">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Viewer Bottom Controls -->
                    <div class="viewer-controls">
                        <button class="control-button" onclick="resetView()" title="Reset View">
                            <i class="fas fa-compress-arrows-alt"></i>
                        </button>
                        <button class="control-button" onclick="toggleGyroscope()" title="Toggle Gyroscope">
                            <i class="fas fa-mobile-alt"></i>
                        </button>
                        <button class="control-button" onclick="reloadScene()" title="Reload Scene">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Right Sidebar - Hotspots -->
            <div class="right-sidebar">
                <div class="right-sidebar-header">
                    <h2 class="text-lg font-semibold">Hotspots</h2>
                    @if($scenes->isNotEmpty())
                    <button class="toolbar-button" onclick="showAddHotspotDialog()">
                        <i class="fas fa-plus"></i>
                        Add Hotspot
                    </button>
                    @endif
                </div>
                
                <div class="hotspot-list">
                    @if($scenes->isNotEmpty() && isset($firstScene) && $firstScene->hotspots->isNotEmpty())
                        @foreach($firstScene->hotspots as $hotspot)
                        <div class="hotspot-item" data-hotspot-id="{{ $hotspot->id }}">
                            <div class="hotspot-item-info">
                                <div class="hotspot-item-title">{{ $hotspot->name }}</div>
                                <div class="hotspot-item-type">
                                    {{ $hotspot->type === 'info' ? 'Information' : 'Navigation' }}
                                    @if($hotspot->type === 'navigation' && $hotspot->target_scene_id)
                                        â {{ $scenes->firstWhere('id', $hotspot->target_scene_id)?->title ?? 'Unknown' }}
                                    @endif
                                </div>
                            </div>
                            <div class="hotspot-item-actions">
                                <button class="hotspot-item-button edit" onclick="editHotspot({{ $hotspot->id }})" title="Edit Hotspot">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="hotspot-item-button delete" onclick="deleteHotspot({{ $hotspot->id }})" title="Delete Hotspot">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        @endforeach
                    @else
                        <div class="empty-state">
                            <div class="empty-state-icon">
                                <i class="fas fa-map-marker-alt"></i>
                            </div>
                            <div class="empty-state-title">No Hotspots Yet</div>
                            <div class="empty-state-description">
                                Add hotspots to connect scenes or provide information
                            </div>
                        </div>
                    @endif
                </div>
            </div>
        </div>

        <!-- Add Hotspot Dialog -->
        <div id="hotspotDialog" class="dialog-overlay hidden">
            <div class="dialog">
                <div class="dialog-header">
                    <h3 class="dialog-title">Add Hotspot</h3>
                    <button onclick="hideAddHotspotDialog()" class="text-muted-foreground hover:text-foreground">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <form id="hotspotForm" onsubmit="handleAddHotspot(event)" class="space-y-4">
                    <div class="form-group">
                        <label class="form-label" for="hotspotName">Hotspot Name</label>
                        <input type="text" id="hotspotName" class="form-input" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="targetScene">Target Scene</label>
                        <select id="targetScene" class="form-input" required>
                            <option value="">Select a scene</option>
                            @foreach($scenes as $scene)
                                @if($scene->id !== $firstScene->id)
                                <option value="{{ $scene->id }}">{{ $scene->title }}</option>
                                @endif
                            @endforeach
                        </select>
                    </div>
                    
                    <div class="flex justify-end space-x-2 pt-4">
                        <button type="button" class="toolbar-button" onclick="hideAddHotspotDialog()">Cancel</button>
                        <button type="submit" class="toolbar-button">Add Hotspot</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Toast Notification -->
        <div id="toast" class="toast">
            <i id="toastIcon" class="fas fa-info-circle"></i>
            <span id="toastMessage"></span>
        </div>

        <!-- Add Export Dialog -->
        <div id="exportDialog" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
            <div class="flex items-center justify-center min-h-screen p-4">
                <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
                    <div class="p-6">
                        <div id="exportContent">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-medium text-gray-900">Export Virtual Tour</h3>
                                <button onclick="closeExportDialog()" class="text-gray-400 hover:text-gray-500">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            
                            <!-- Error message container -->
                            <div id="exportError" class="hidden mb-4 p-3 bg-red-100 text-red-700 rounded-md">
                                <p class="text-sm"></p>
                            </div>
                            
                            <div class="space-y-4">
                                <div>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="includeViewer" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked>
                                        <span class="ml-2 text-sm text-gray-700">Include Viewer Files</span>
                                    </label>
                                </div>
                                <div>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="includePWA" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked>
                                        <span class="ml-2 text-sm text-gray-700">Include PWA Files</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="mt-6 flex justify-end space-x-3">
                                <button type="button" onclick="closeExportDialog()" 
                                        class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200">
                                    Cancel
                                </button>
                                <button type="button" onclick="startExport()" 
                                        class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700">
                                    Export
                                </button>
                            </div>
                        </div>
                        
                        <div id="exportLoading" class="hidden">
                            <div class="flex flex-col items-center justify-center space-y-4">
                                <div class="animate-spin rounded-full h-12 w-12 border-4 border-blue-600 border-t-transparent"></div>
                                <p class="text-gray-700">Generating export package...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        // JavaScript for virtual 360 tour editor
        let viewer = null;
        let autoRotate = false;
        let gyroscopeEnabled = false;
        let currentSceneId = null;
        let isHotspotPlacementMode = false;
        let lastHotspotCoords = null;
        let currentHotspotId = null;
        let mouseDebugDisplay = null;
        
        // Initialize mouse tracking
        let mouseInfo = {
            x: 0,
            y: 0,
            isDragging: false
        };

        // Track mouse movement
        document.addEventListener('mousemove', (e) => {
            mouseInfo.x = e.clientX;
            mouseInfo.y = e.clientY;
        });

        // Fix for route function
        window.route = function(name, params) {
            const routes = {
                'agent.virtual-360.scenes.hotspots.destroy': '/agent/virtual-360/{virtualTour}/scenes/{scene}/hotspots/{hotspot}',
                'agent.scenes.hotspots.destroy': '/agent/{virtualTour}/scenes/{scene}/hotspots/{hotspot}'
            };
            
            let url = routes[name] || '';
            
            // Replace route parameters
            if (params) {
                for (const key in params) {
                    url = url.replace(`{${key}}`, params[key]);
                }
            }
            
            return url;
        };

        document.addEventListener('DOMContentLoaded', function() {
            // Tambahkan element untuk debugging mouse position
            mouseDebugDisplay = document.createElement('div');
            mouseDebugDisplay.style.position = 'fixed';
            mouseDebugDisplay.style.bottom = '60px';
            mouseDebugDisplay.style.left = '10px';
            mouseDebugDisplay.style.backgroundColor = 'rgba(0,0,0,0.7)';
            mouseDebugDisplay.style.color = 'white';
            mouseDebugDisplay.style.padding = '5px 10px';
            mouseDebugDisplay.style.borderRadius = '4px';
            mouseDebugDisplay.style.fontSize = '12px';
            mouseDebugDisplay.style.fontFamily = 'monospace';
            mouseDebugDisplay.style.zIndex = '1000';
            document.body.appendChild(mouseDebugDisplay);
            
            // Track mouse movement inside viewer
            const viewerElement = document.getElementById('viewer');
            if (viewerElement) {
                viewerElement.addEventListener('mousemove', function(e) {
                    if (!viewer) return;
            
            try {
                const container = viewer.getContainer();
                const rect = container.getBoundingClientRect();
                
                // Relatif position
                const mouseX = (e.clientX - rect.left) / rect.width;
                const mouseY = (e.clientY - rect.top) / rect.height;
                
                // Get current view menggunakan getConfig, bukan getPosition
                const currentView = viewer.getConfig();
                const currentYaw = currentView.yaw || 0;
                const currentPitch = currentView.pitch || 0;
                const hfov = currentView.hfov || 100;
                
                // Calculate offset
                const yawOffset = (mouseX - 0.5) * hfov;
                const pitchOffset = (0.5 - mouseY) * (hfov * rect.height / rect.width);
                
                // Final positions
                const yaw = currentYaw + yawOffset;
                const pitch = currentPitch + pitchOffset;
                
                        // Update display
                    mouseInfo.innerText = `Mouse: P=${pitch.toFixed(2)}Â°, Y=${yaw.toFixed(2)}Â°`;
            } catch(err) {
                console.error('Error tracking mouse:', err);
            }
                });
            }
        });

        // Get virtual tour ID
        function getVirtualTourId() {
            const editor = document.getElementById('editor');
            if (!editor) {
                console.error('Editor element not found');
                return null;
            }
            
            const tourId = editor.dataset.tourId;
            if (!tourId) {
                console.error('Virtual Tour ID not found in editor element');
                return null;
            }
            
            return tourId;
        }

        // Debug virtual tour ID
        console.log('Virtual Tour ID:', document.getElementById('virtualTourId')?.value);

        // Toast notification function
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
                type === 'error' ? 'bg-red-500' : 
                type === 'success' ? 'bg-green-500' : 
                'bg-blue-500'
            } text-white`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Initialize viewer with first scene if available
            const firstSceneElement = document.querySelector('.scene-item');
            if (firstSceneElement) {
                const firstSceneUrl = firstSceneElement.dataset.sceneUrl;
                const firstSceneId = firstSceneElement.dataset.sceneId;
                if (firstSceneUrl) {
                    currentSceneId = firstSceneId; // Set currentSceneId first
                    loadScene(firstSceneUrl);
                    
                    // Load initial hotspots after a short delay to ensure viewer is ready
                    setTimeout(() => {
                        if (currentSceneId) {
                            console.log('Loading initial hotspots for scene:', currentSceneId);
                            loadHotspots(currentSceneId);
                        }
                    }, 1500);
                }
            }

            // Preload hotspots for all scenes to ensure they're available even after refresh
            preloadAllScenesHotspots();

            // Add error handling for missing elements
            if (!document.getElementById('viewer')) {
                console.error('Viewer element not found');
                showToast('Error: Viewer element not found', 'error');
            }

            // Update debug information
            updateDebugInfo();
        });

        // Preload all scenes' hotspots data
        function preloadAllScenesHotspots() {
            const sceneItems = document.querySelectorAll('.scene-item');
            console.log('Preloading hotspots for all scenes, count:', sceneItems.length);
            
            sceneItems.forEach(sceneItem => {
                const sceneId = sceneItem.dataset.sceneId;
                if (sceneId) {
                    // Use AJAX to fetch hotspots for this scene and store in a cache
                    fetch(`/agent/virtual-360/scenes/${sceneId}/hotspots`, {
                        headers: {
                            'Accept': 'application/json',
                            'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.hotspots) {
                            console.log(`Preloaded ${data.hotspots.length} hotspots for scene ${sceneId}`);
                            
                            // Update hotspot count in UI
                            const hotspotCountElement = sceneItem.querySelector('.hotspot-count');
                            if (hotspotCountElement) {
                                hotspotCountElement.textContent = data.hotspots.length;
                            } else {
                                // Add hotspot count indicator if it doesn't exist
                                const sceneActions = sceneItem.querySelector('.scene-item-actions');
                                if (sceneActions) {
                                    const countBadge = document.createElement('span');
                                    countBadge.className = 'hotspot-count px-1.5 py-0.5 text-xs bg-primary rounded-full text-white ml-1';
                                    countBadge.textContent = data.hotspots.length;
                                    sceneActions.insertBefore(countBadge, sceneActions.firstChild);
                                }
                            }
                        }
                    })
                    .catch(error => {
                        console.error(`Failed to preload hotspots for scene ${sceneId}:`, error);
                    });
                }
            });
        }

        // Modified loadScene function to handle hotspots better
        function loadScene(sceneUrl) {
            const sceneElements = document.querySelectorAll('.scene-item');
            const currentScene = Array.from(sceneElements).find(el => el.dataset.sceneUrl === sceneUrl);
            
            if (!currentScene) {
                console.error('Scene not found:', sceneUrl);
                return;
            }

            currentSceneId = currentScene.dataset.sceneId;
            
            // Destroy existing viewer if it exists
            if (viewer) {
                viewer.destroy();
            }

            // Show loading indicator
            document.getElementById('loading').classList.remove('hidden');

            try {
                // Initialize new viewer
                viewer = initializeViewer(sceneUrl);

                // Add event listeners for the viewer
                viewer.on('load', function() {
                    console.log('Scene loaded successfully');
                    document.getElementById('loading').classList.add('hidden');
                    
                    // Load hotspots after scene is loaded
                    loadHotspots(currentSceneId);
                    
                    // Update scene thumbnails
                    updateSceneThumbnails();
                });

                viewer.on('error', function(err) {
                    console.error('Error loading scene:', err);
                    showToast('Error loading scene', 'error');
                    document.getElementById('loading').classList.add('hidden');
                });

            } catch (error) {
                console.error('Error initializing viewer:', error);
                showToast('Error initializing viewer', 'error');
                document.getElementById('loading').classList.add('hidden');
            }
        }

        // Inisialisasi viewer dengan konfigurasi yang tepat
        function initializeViewer(sceneUrl) {
            return pannellum.viewer('viewer', {
                type: "equirectangular",
                panorama: sceneUrl,
                autoLoad: true,
                autoRotate: -2,
                compass: false,
                hotSpotDebug: true, // Aktifkan untuk debug
                hotSpots: [],
                default: {
                    firstScene: true,
                    sceneFadeDuration: 1000,
                    autoRotate: 0,
                    compass: false
                },
                // Tambahkan event handler untuk menangkap koordinat klik
                mousemove: function(event) {
                    if (!isHotspotPlacementMode) return;
                    updateCoordinatesDebug(event);
                },
                mousedown: function(event) {
                    if (!isHotspotPlacementMode) return;
                    handleSceneClick(event);
                }
            });
        }

        function createHotspot(hotspotData) {
            if (!viewer) {
                console.error('Viewer not initialized');
                return;
            }

            try {
                const hotspotConfig = {
                    id: `hotspot-${hotspotData.id}`,
                    pitch: parseFloat(hotspotData.pitch),
                    yaw: parseFloat(hotspotData.yaw),
                    type: hotspotData.type,
                    text: hotspotData.name,
                    cssClass: `custom-hotspot ${hotspotData.type}`,
                    createTooltipFunc: createTooltipFunc,
                    clickHandlerFunc: (event, hotspot) => {
                        if (hotspotData.type === 'navigation' && hotspotData.target_scene_id) {
                            const targetScene = document.querySelector(
                                `.scene-item[data-scene-id="${hotspotData.target_scene_id}"]`
                            );
                            if (targetScene) {
                                loadScene(targetScene.dataset.sceneUrl);
                            }
                        }
                    }
                };

                viewer.addHotSpot(hotspotConfig);
                console.log('Hotspot created:', hotspotConfig);

            } catch (error) {
                console.error('Error creating hotspot:', error);
                showToast('Error creating hotspot', 'error');
            }
        }

        // Custom tooltip function
        function createTooltipFunc(divElement, args) {
            const tooltip = document.createElement('div');
            tooltip.classList.add('hotspot-tooltip');
            tooltip.textContent = args.text;
            divElement.appendChild(tooltip);
        }

        function handleSceneClick(event) {
            if (!isHotspotPlacementMode || !viewer) return;

            try {
                const coords = viewer.mouseEventToCoords(event);
                lastHotspotCoords = {
                    pitch: coords[0],
                    yaw: coords[1]
                };
                
                console.log('Captured coordinates:', lastHotspotCoords);
                showAddHotspotDialog();
                
                // Update debug display
                updateCoordinatesDebug({
                    pitch: coords[0],
                    yaw: coords[1]
                });
                
            } catch (error) {
                console.error('Error capturing coordinates:', error);
                showToast('Error capturing coordinates', 'error');
            }
        }

        function updateCoordinatesDebug(coords) {
            if (!mouseDebugDisplay) return;
            
            mouseDebugDisplay.textContent = `Pitch: ${coords.pitch.toFixed(2)}Â°, Yaw: ${coords.yaw.toFixed(2)}Â°`;
        }

        // Helper function to check if viewer is initialized
        function isViewerInitialized() {
            return typeof viewer !== 'undefined' && viewer !== null;
        }

        // Update debug information
        function updateDebugInfo() {
            const debugInfo = document.getElementById('debugStatus');
            if (debugInfo) {
                const status = isViewerInitialized() ? 'Viewer initialized' : 'Viewer not initialized';
                const sceneInfo = currentSceneId ? `Current Scene ID: ${currentSceneId}` : 'No scene loaded';
                debugInfo.textContent = `Status: ${status} | ${sceneInfo}`;
            }
        }

        function handleUploadScene(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validate file type
            if (!file.type.match('image/jpeg') && !file.type.match('image/png')) {
                showToast('Please upload a JPG or PNG file', 'error');
                return;
            }

            // Show loading state
            const loadingElement = document.getElementById('loading');
            if (loadingElement) {
                loadingElement.classList.remove('hidden');
            }
            document.getElementById('debugStatus').textContent = 'Status: Uploading scene...';

            // Create form data
            const formData = new FormData();
            formData.append('title', file.name.split('.')[0]); // Use filename as title
            formData.append('image', file);

            // Upload scene
            fetch('{{ route("agent.virtual-360.add-scene", $virtualTour->id) }}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRF-TOKEN': '{{ csrf_token() }}'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Create new scene item
                    const sceneList = document.querySelector('.scene-list');
                    const newSceneItem = document.createElement('div');
                    newSceneItem.className = 'scene-item';
                    newSceneItem.dataset.sceneId = data.scene.id;
                    newSceneItem.dataset.sceneUrl = data.scene.image_url;
                    newSceneItem.onclick = function() { loadScene(data.scene.image_url); };
                    newSceneItem.innerHTML = `
                        <div class="scene-item-title">${data.scene.title}</div>
                        <div class="scene-item-actions">
                            <button class="scene-item-button" onclick="editScene(${data.scene.id})" title="Edit Scene">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="scene-item-button" onclick="deleteScene(${data.scene.id})" title="Delete Scene">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    sceneList.appendChild(newSceneItem);

                    // Tampilkan pesan sukses tanpa memuat scene
                    showToast('Scene berhasil diupload', 'success');
                    document.getElementById('debugStatus').textContent = 'Status: Scene uploaded successfully';
                    
                    // Jika tidak ada scene yang dimuat, muat scene ini
                    if (!currentSceneId && viewer === null) {
                        loadScene(data.scene.image_url);
                    }
                } else {
                    throw new Error(data.message || 'Failed to upload scene');
                }
            })
            .catch(error => {
                showToast(error.message, 'error');
                console.error('Upload error:', error);
            })
            .finally(() => {
                if (loadingElement) {
                    loadingElement.classList.add('hidden');
                }
            });
        }

        function deleteScene(sceneId) {
            // Tambahkan pengecekan untuk mencegah klik tidak sengaja
            if (!sceneId) {
                showToast('Scene ID tidak valid', 'error');
                return;
            }
            
            // Cek apakah ini scene terakhir
            const sceneItems = document.querySelectorAll('.scene-item');
            if (sceneItems.length <= 1) {
                showToast('Tidak dapat menghapus scene terakhir', 'error');
                return;
            }
            
            // Cek apakah scene ini direferensikan oleh hotspot
            const isReferenced = checkSceneReferences(sceneId);
            
            // Tampilkan konfirmasi
            let confirmMessage = 'Apakah Anda yakin ingin menghapus scene ini?';
            if (isReferenced) {
                confirmMessage += '\n\nPERINGATAN: Scene ini direferensikan oleh hotspot dari scene lain. Menghapus scene ini akan membuat hotspot-hotspot tersebut tidak berfungsi.';
            }
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            // Tampilkan loading indicator
            showToast('Menghapus scene...', 'info');
            document.getElementById('debugStatus').textContent = 'Status: Deleting scene ' + sceneId;
            
            // Dapatkan CSRF token
            const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
            
            // Kirim request
            fetch(`/agent/virtual-360/scenes/${sceneId}`, {
                method: 'DELETE',
                headers: {
                    'X-CSRF-TOKEN': csrfToken,
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                // Check jika response bukan JSON
                if (!response.headers.get('content-type')?.includes('application/json')) {
                    return response.text().then(text => {
                        throw new Error(`Server returned non-JSON response: ${text.substring(0, 100)}...`);
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log('Delete scene response:', data);
                
                if (data.success) {
                    // Hapus scene dari DOM
                    const sceneElement = document.querySelector(`[data-scene-id="${sceneId}"]`);
                    if (sceneElement) {
                        // Periksa apakah scene yang dihapus adalah yang aktif
                        const isActive = sceneElement.classList.contains('active');
                        
                        // Hapus elemen dari DOM
                        sceneElement.remove();
                        
                        // Jika scene yang dihapus adalah yang aktif, load scene lain
                        if (isActive) {
                            const nextScene = document.querySelector('.scene-item');
                            if (nextScene) {
                                const nextSceneUrl = nextScene.dataset.sceneUrl;
                                loadScene(nextSceneUrl);
                            }
                        }
                        
                        showToast('Scene berhasil dihapus', 'success');
                        document.getElementById('debugStatus').textContent = 'Status: Scene deleted successfully';
                    } else {
                        // Jika gagal menemukan elemen, muat ulang halaman
                        showToast('Scene berhasil dihapus, memuat ulang...', 'success');
                        setTimeout(() => window.location.reload(), 1000);
                    }
                } else {
                    throw new Error(data.message || 'Gagal menghapus scene');
                }
            })
            .catch(error => {
                console.error('Error deleting scene:', error);
                showToast('Error: ' + error.message, 'error');
                document.getElementById('debugStatus').textContent = 'Status: Error deleting scene - ' + error.message;
            });
        }

        // Fungsi untuk memeriksa apakah scene direferensikan oleh hotspot dari scene lain
        function checkSceneReferences(sceneId) {
            let isReferenced = false;
            
            // Periksa semua hotspot di semua scene
            document.querySelectorAll('.scene-item').forEach(scene => {
                const currentSceneId = scene.dataset.sceneId;
                if (currentSceneId !== sceneId) {
                    // Periksa hotspot di scene ini
                    document.querySelectorAll(`[data-target-scene-id="${sceneId}"]`).forEach(() => {
                        isReferenced = true;
                    });
                }
            });
            
            return isReferenced;
        }

        function editScene(sceneId) {
            // Find the scene item
            const sceneItem = document.querySelector(`[data-scene-id="${sceneId}"]`);
            if (!sceneItem) return;

            // Show edit dialog
            const dialog = document.createElement('div');
            dialog.className = 'dialog-overlay';
            dialog.innerHTML = `
                <div class="dialog">
                    <div class="dialog-header">
                        <h3 class="dialog-title">Edit Scene</h3>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" class="text-muted-foreground hover:text-foreground">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <form onsubmit="handleEditScene(event, ${sceneId})" class="space-y-4">
                        <div class="form-group">
                            <label class="form-label" for="sceneTitle">Scene Title</label>
                            <input type="text" id="sceneTitle" class="form-input" value="${sceneItem.querySelector('.scene-item-title').textContent}" required>
                        </div>
                        <div class="flex justify-end space-x-2 pt-4">
                            <button type="button" class="toolbar-button" onclick="this.parentElement.parentElement.parentElement.remove()">Cancel</button>
                            <button type="submit" class="toolbar-button">Save Changes</button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(dialog);
        }

        function handleEditScene(event, sceneId) {
            event.preventDefault();
            const title = document.getElementById('sceneTitle').value;

            fetch(`{{ route('agent.virtual-360.scenes.update', ['scene' => ':sceneId']) }}`.replace(':sceneId', sceneId), {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': '{{ csrf_token() }}'
                },
                body: JSON.stringify({ title })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Update scene title in sidebar
                    const sceneItem = document.querySelector(`[data-scene-id="${sceneId}"]`);
                    if (sceneItem) {
                        sceneItem.querySelector('.scene-item-title').textContent = title;
                    }
                    // Update scene title in viewer header if this is the current scene
                    if (currentSceneId === sceneId) {
                        document.querySelector('.viewer-header h2').textContent = title;
                    }
                    showToast('Scene updated successfully', 'success');
                } else {
                    throw new Error(data.message || 'Failed to update scene');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Failed to update scene: ' + error.message, 'error');
            })
            .finally(() => {
                // Remove dialog
                const dialog = document.querySelector('.dialog-overlay');
                if (dialog) {
                    dialog.remove();
                }
            });
        }

        function toggleHotspotPlacement() {
            isHotspotPlacementMode = !isHotspotPlacementMode;
            const button = document.querySelector('[onclick="toggleHotspotPlacement()"]');
            
            if (isHotspotPlacementMode) {
                button.classList.add('bg-primary');
                button.innerHTML = '<i class="fas fa-times"></i> Cancel Placement';
                
                // Hapus event listener lama jika ada
                document.getElementById('viewer').removeEventListener('click', handleHotspotPlacement);
                
                // Tambahkan listener baru dengan opsi capture untuk menangkap event sebelum diproses oleh library
                document.getElementById('viewer').addEventListener('click', handleHotspotPlacement, { capture: true });
                
                // Show helper message
                showToast('Click anywhere on the scene to place a hotspot', 'info');
            } else {
                button.classList.remove('bg-primary');
                button.innerHTML = '<i class="fas fa-crosshairs"></i> Place Hotspot';
                
                // Remove click event listener
                document.getElementById('viewer').removeEventListener('click', handleHotspotPlacement, { capture: true });
                
                // Remove any temporary hotspots
                try {
                    viewer.removeHotSpot('temp-placement-hotspot');
                    const debugPoints = document.querySelectorAll('.debug-point');
                    debugPoints.forEach(el => {
                        try {
                            const id = el.id;
                            if (id) viewer.removeHotSpot(id);
                        } catch(e) {}
                    });
                } catch(e) {}
            }
        }

        // Override metode penempatan hotspot dengan metode yang lebih langsung
        function handleHotspotPlacement(event) {
            if (!isHotspotPlacementMode || !viewer) return;

            // Prevent default behavior
            event.preventDefault();
            event.stopPropagation();
            
            try {
                const container = viewer.getContainer();
                const rect = container.getBoundingClientRect();
                
                // Cara 1: Gunakan titik tengah kemudian offset berdasarkan FOV
                const viewerCenter = {
                    x: rect.width / 2,
                    y: rect.height / 2
                };
                
                // Hitung jarak mouse dari tengah, dalam pixel
                const mouseOffset = {
                    x: event.clientX - rect.left - viewerCenter.x,
                    y: viewerCenter.y - (event.clientY - rect.top) // Y terbalik (atas negatif)
                };
                
                // Dapatkan current view dari pannellum
                // Gunakan viewer.getConfig untuk mendapatkan posisi, bukan getPosition
                const currentView = viewer.getConfig();
                const currentPitch = currentView.pitch || 0;
                const currentYaw = currentView.yaw || 0;
                
                // Dapatkan current field of view
                const hfov = currentView.hfov || 100;
                
                // Konversi pixel offset ke derajat
                // Nilai asumsi: di tengah layar, setiap pixel merepresentasikan hfov/width derajat 
                const degreesPerPixelX = hfov / rect.width;
                const degreesPerPixelY = hfov / rect.width * (rect.height / rect.width);
                
                const yawChange = mouseOffset.x * degreesPerPixelX;
                const pitchChange = mouseOffset.y * degreesPerPixelY;
                
                // Hitung final coordinates
                const pitch = clamp(currentPitch + pitchChange, -90, 90);
                const yaw = currentYaw + yawChange;
                
                console.log('Placement calculation:', {
                    mouseOffset,
                    currentView: {
                        pitch: currentPitch,
                        yaw: currentYaw,
                        hfov: hfov
                    },
                    degPerPixel: {
                        x: degreesPerPixelX,
                        y: degreesPerPixelY
                    },
                    change: {
                        pitch: pitchChange,
                        yaw: yawChange
                    },
                    result: {
                        pitch: pitch,
                        yaw: yaw
                    }
                });
                
                // Simpan koordinat
                lastHotspotCoords = {
                    pitch: pitch,
                    yaw: yaw
                };
                
                // Tampilkan visual feedback
                createTemporaryHotspot(pitch, yaw);
                
                // Tampilkan dialog untuk menyelesaikan pembuatan hotspot
                showAddHotspotDialog();
            } catch (error) {
                console.error('Error calculating hotspot position:', error);
                showToast('Error: ' + error.message, 'error');
            }
        }

        // Helper function untuk membatasi nilai
        function clamp(value, min, max) {
            return Math.min(Math.max(value, min), max);
        }

        // Override saveHotspot untuk memastikan menggunakan koordinat yang tepat
        function saveHotspot() {
            // Ambil data dari form
            const name = document.getElementById('hotspot_name').value;
            const type = document.getElementById('hotspot_type').value;
            
            if (!name) {
                showToast('Silakan masukkan nama hotspot', 'error');
                return;
            }
            
            // Pastikan koordinat diambil dari lastHotspotCoords, bukan dari form
            if (!lastHotspotCoords) {
                showToast('Koordinat hotspot tidak valid, silakan coba lagi', 'error');
                return;
            }
            
            // Log koordinat yang akan dikirim
            console.log('Saving hotspot with coordinates:', lastHotspotCoords);
            
            // Buat form data
            const formData = new FormData();
            formData.append('name', name);
            formData.append('type', type);
            formData.append('pitch', lastHotspotCoords.pitch);
            formData.append('yaw', lastHotspotCoords.yaw);
            
            // Jika hotspot jenis scene, tambahkan target scene
            if (type === 'scene') {
                const targetScene = document.getElementById('target_scene').value;
                if (!targetScene) {
                    showToast('Silakan pilih scene tujuan', 'error');
                    return;
                }
                formData.append('target_scene_id', targetScene);
            }
            
            // Dapatkan scene ID aktif
            const activeScene = document.querySelector('.scene-item.active');
            if (!activeScene) {
                showToast('Tidak ada scene aktif', 'error');
                return;
            }
            
            const sceneId = activeScene.dataset.sceneId;
            formData.append('scene_id', sceneId);
            
            // Tampilkan loading
            const saveButton = document.querySelector('#addHotspotForm button[type="submit"]');
            if (saveButton) {
                saveButton.disabled = true;
                saveButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menyimpan...';
            }
            
            // Kirim request
            fetch(`/agent/virtual-360/scenes/${sceneId}/hotspots`, {
                method: 'POST',
                headers: {
                    'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').getAttribute('content'),
                    'Accept': 'application/json'
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('Hotspot berhasil ditambahkan', 'success');
                    
                    // Close modal
                    document.getElementById('addHotspotModal').classList.add('hidden');
                    
                    // Exit placement mode
                    isHotspotPlacementMode = false;
                    const placeButton = document.querySelector('[onclick="toggleHotspotPlacement()"]');
                    if (placeButton) {
                        placeButton.classList.remove('bg-primary');
                        placeButton.innerHTML = '<i class="fas fa-crosshairs"></i> Place Hotspot';
                    }
                    
                    // Remove event listener
                    document.getElementById('viewer').removeEventListener('click', handleHotspotPlacement, { capture: true });
                    
                    // Reload hotspots
                    reloadHotspotsForScene(sceneId);
                } else {
                    showToast(data.message || 'Gagal menambahkan hotspot', 'error');
                }
            })
            .catch(error => {
                console.error('Error saving hotspot:', error);
                showToast('Error: ' + error.message, 'error');
            })
            .finally(() => {
                // Reset button
                if (saveButton) {
                    saveButton.disabled = false;
                    saveButton.innerHTML = 'Simpan Hotspot';
                }
            });
        }

        // Tambahkan event listener untuk form
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('addHotspotForm');
            if (form) {
                form.addEventListener('submit', function(event) {
                    event.preventDefault();
                    saveHotspot();
                });
            }
        });

        // Tambahkan styles tambahan untuk hotspot sementara
        const styleElement = document.createElement('style');
        styleElement.textContent = `
            .temp-hotspot {
                background-color: rgba(255, 0, 0, 0.8) !important;
                border: 4px solid white !important;
                width: 24px !important;
                height: 24px !important;
                margin-left: -12px !important;
                margin-top: -12px !important;
                border-radius: 50% !important;
                animation: pulse 1.5s infinite;
                z-index: 1000 !important;
            }
            
            @keyframes pulse {
                0% { transform: scale(1); opacity: 1; }
                50% { transform: scale(1.2); opacity: 0.8; }
                100% { transform: scale(1); opacity: 1; }
            }
        `;
        document.head.appendChild(styleElement);

        // Add debug switch and code debug
        let debug = true;

        // Tambahkan CSS untuk marker debug
        document.addEventListener('DOMContentLoaded', function() {
            // Tambahkan styles untuk marker debug
            const style = document.createElement('style');
            style.textContent = `
                .debug-marker {
                    width: 10px !important;
                    height: 10px !important;
                    opacity: 0.8;
                    border-radius: 50%;
                    pointer-events: none;
                }
                
                .debug-center {
                    background-color: red !important;
                    width: 15px !important;
                    height: 15px !important;
                }
                
                .debug-left, .debug-right {
                    background-color: blue !important;
                }
                
                .debug-top, .debug-bottom {
                    background-color: green !important;
                }
                
                .hotspot-tooltip {
                    background-color: rgba(0,0,0,0.7);
                    padding: 5px 10px;
                    border-radius: 5px;
                    font-size: 12px;
                    white-space: nowrap;
                }
            `;
            document.head.appendChild(style);
            
            // Tambahkan debug toggle
            const debugBtn = document.createElement('button');
            debugBtn.innerText = 'Toggle Debug';
            debugBtn.className = 'position-fixed m-2 p-2 bg-red-500 text-white rounded';
            debugBtn.style.top = '110px';
            debugBtn.style.right = '10px';
            debugBtn.style.zIndex = '1000';
            debugBtn.onclick = function() {
                debug = !debug;
                debugBtn.classList.toggle('bg-red-500');
                debugBtn.classList.toggle('bg-green-500');
                
                // Tampilkan status
                showToast(debug ? 'Debug mode enabled' : 'Debug mode disabled', 'info');
                
                // Toggle tampilan marker debug
                document.querySelectorAll('.debug-marker').forEach(el => {
                    el.style.display = debug ? 'block' : 'none';
                });
            };
            document.body.appendChild(debugBtn);
            
            // Tambahkan info posisi mouse
            const mouseInfo = document.createElement('div');
            mouseInfo.id = 'mouse-info';
            mouseInfo.className = 'position-fixed bg-black bg-opacity-75 text-white p-2 rounded';
            mouseInfo.style.bottom = '10px';
            mouseInfo.style.left = '10px';
            mouseInfo.style.zIndex = '1000';
            mouseInfo.style.fontSize = '12px';
            mouseInfo.style.fontFamily = 'monospace';
            mouseInfo.innerText = 'Mouse: --.--Â°, --.--Â°';
            document.body.appendChild(mouseInfo);
            
            // Track mouse movement
            const viewerElement = document.getElementById('viewer');
            if (viewerElement) {
                viewerElement.addEventListener('mousemove', function(e) {
                    if (!viewer) return;
                    
                    try {
                        const container = viewer.getContainer();
                        const rect = container.getBoundingClientRect();
                        
                        // Relatif position
                        const mouseX = (e.clientX - rect.left) / rect.width;
                        const mouseY = (e.clientY - rect.top) / rect.height;
                        
                        // Get current view menggunakan getConfig, bukan getPosition
                        const currentView = viewer.getConfig();
                        const currentYaw = currentView.yaw || 0;
                        const currentPitch = currentView.pitch || 0;
                        const hfov = currentView.hfov || 100;
                        
                        // Calculate offset
                        const yawOffset = (mouseX - 0.5) * hfov;
                        const pitchOffset = (0.5 - mouseY) * (hfov * rect.height / rect.width);
                        
                        // Final positions
                        const yaw = currentYaw + yawOffset;
                        const pitch = currentPitch + pitchOffset;
                        
                        // Update display
                        mouseInfo.innerText = `Mouse: P=${pitch.toFixed(2)}Â°, Y=${yaw.toFixed(2)}Â°`;
                    } catch(err) {
                        console.error('Error tracking mouse:', err);
                    }
                });
            }
        });

        // Fungsi untuk mengupdate formulir dengan koordinat
        function updatePositionFields(pitch, yaw) {
            const pitchField = document.getElementById('hotspot_pitch');
            const yawField = document.getElementById('hotspot_yaw');
            
            if (pitchField && yawField) {
                pitchField.value = pitch.toFixed(2);
                yawField.value = yaw.toFixed(2);
            }
        }

        // Fungsi untuk membuat hotspot sementara
        function createTemporaryHotspot(pitch, yaw) {
            const tempId = 'temp-placement-hotspot';
            
            // Hapus temporary hotspot yang ada
            try {
                viewer.removeHotSpot(tempId);
            } catch (e) {
                // Ignore if not exists
            }
            
            // Buat hotspot baru
            viewer.addHotSpot({
                id: tempId,
                pitch: pitch,
                yaw: yaw,
                type: 'info',
                cssClass: 'temp-hotspot',
                createTooltipFunc: (div) => {
                    div.innerHTML = `<div class="hotspot-tooltip">
                        Position: P=${pitch.toFixed(2)}, Y=${yaw.toFixed(2)}
                    </div>`;
                }
            });
            
            // Update form jika ada
            updatePositionFields(pitch, yaw);
        }

        // Modify showAddHotspotDialog to include position adjustment
        function showAddHotspotDialog() {
            const dialog = document.getElementById('hotspotDialog');
            dialog.classList.remove('hidden');
            
            // Find the form
            const form = document.getElementById('hotspotForm');
            
            // Cari atau buat select untuk target scene
            let targetSceneSelect = form.querySelector('#targetScene');
            
            // Jika sudah ada, kosongkan dulu
            if (targetSceneSelect) {
                // Simpan opsi default
                targetSceneSelect.innerHTML = '<option value="">Select a target scene</option>';
                
                // Perbarui opsi dengan semua scene tersedia
                const activeSceneId = document.querySelector('.scene-item.active')?.dataset.sceneId;
                const scenes = document.querySelectorAll('.scene-item');
                
                // Log untuk debugging
                console.log('Current active scene:', activeSceneId);
                console.log('Total available scenes:', scenes.length);
                
                // Tambahkan semua scene selain scene saat ini
                scenes.forEach(scene => {
                    const sceneId = scene.dataset.sceneId;
                    const sceneTitle = scene.querySelector('.scene-item-title')?.textContent || 'Unnamed Scene';
                    
                    // Skip scene yang aktif
                    if (sceneId && sceneId !== activeSceneId) {
                        const option = document.createElement('option');
                        option.value = sceneId;
                        option.textContent = sceneTitle;
                        targetSceneSelect.appendChild(option);
                        
                        console.log('Added scene option:', sceneId, sceneTitle);
                    }
                });
            }
            
            // Check if we need to add coordinate fields
            if (!form.querySelector('#hotspotPitch')) {
                // Add fields for pitch and yaw to allow manual adjustment
                const coordsFieldset = document.createElement('fieldset');
                coordsFieldset.className = 'form-group';
                coordsFieldset.innerHTML = `
                    <legend class="form-label">Position</legend>
                    <div class="flex gap-2 mb-2">
                        <div class="w-1/2">
                            <label class="form-label text-sm" for="hotspotPitch">Pitch</label>
                            <input type="number" id="hotspotPitch" name="pitch" class="form-input" step="0.1" value="${lastHotspotCoords ? lastHotspotCoords.pitch.toFixed(2) : '0.00'}">
                        </div>
                        <div class="w-1/2">
                            <label class="form-label text-sm" for="hotspotYaw">Yaw</label>
                            <input type="number" id="hotspotYaw" name="yaw" class="form-input" step="0.1" value="${lastHotspotCoords ? lastHotspotCoords.yaw.toFixed(2) : '0.00'}">
                        </div>
                    </div>
                    <button type="button" id="adjustPositionBtn" class="mb-2 px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded text-xs">
                        <i class="fas fa-crosshairs mr-1"></i> Click to Adjust Position
                    </button>
                    <div class="grid grid-cols-3 gap-1 mb-2">
                        <button type="button" class="posAdjust px-2 py-1 bg-gray-700 text-white rounded text-xs" data-pitch="-1" data-yaw="0">Up</button>
                        <button type="button" class="posAdjust px-2 py-1 bg-gray-700 text-white rounded text-xs" data-pitch="0" data-yaw="0">Center</button>
                        <button type="button" class="posAdjust px-2 py-1 bg-gray-700 text-white rounded text-xs" data-pitch="1" data-yaw="0">Down</button>
                        <button type="button" class="posAdjust px-2 py-1 bg-gray-700 text-white rounded text-xs" data-pitch="0" data-yaw="-1">Left</button>
                        <button type="button" class="posAdjust px-2 py-1 bg-gray-700 text-white rounded text-xs" data-pitch="0" data-yaw="1">Right</button>
                        <button type="button" class="posAdjust px-2 py-1 bg-gray-700 text-white rounded text-xs" data-pitch="0" data-yaw="5">Front</button>
                    </div>
                `;
                
                // Add the fieldset before the buttons
                const buttonsDiv = form.querySelector('.flex.justify-end');
                form.insertBefore(coordsFieldset, buttonsDiv);
                
                // Add input event listeners to update the temporary hotspot
                const pitchInput = document.getElementById('hotspotPitch');
                const yawInput = document.getElementById('hotspotYaw');
                
                [pitchInput, yawInput].forEach(input => {
                    input.addEventListener('change', () => {
                        const newPitch = parseFloat(pitchInput.value);
                        const newYaw = parseFloat(yawInput.value);
                        
                        if (!isNaN(newPitch) && !isNaN(newYaw)) {
                            lastHotspotCoords = {
                                pitch: newPitch,
                                yaw: newYaw
                            };
                            createTemporaryHotspot(newPitch, newYaw);
                        }
                    });
                });
                
                // Add click handler for the adjust position button
                document.getElementById('adjustPositionBtn').addEventListener('click', () => {
                    // Hide dialog temporarily
                    dialog.classList.add('hidden');
                    
                    // Show instruction
                    showToast('Click on the scene to set new hotspot position', 'info');
                    
                    // Setup one-time click handler
                    const viewerElement = document.getElementById('viewer');
                    const clickHandler = (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        // Get coordinates
                        const coords = viewer.mouseEventToCoords(e);
                        
                        // Update coordinates
                        lastHotspotCoords = {
                            pitch: coords[1],
                            yaw: coords[0]
                        };
                        
                        // Update visual and inputs
                        createTemporaryHotspot(lastHotspotCoords.pitch, lastHotspotCoords.yaw);
                        
                        // Show dialog again
                        dialog.classList.remove('hidden');
                        
                        // Remove the handler
                        viewerElement.removeEventListener('click', clickHandler);
                    };
                    
                    viewerElement.addEventListener('click', clickHandler);
                });
                
                // Add click handlers for position adjustment buttons
                const posButtons = form.querySelectorAll('.posAdjust');
                posButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        const pitchAdj = parseFloat(button.getAttribute('data-pitch'));
                        const yawAdj = parseFloat(button.getAttribute('data-yaw'));
                        
                        if (button.textContent === 'Center') {
                            // Set to current view center
                            const viewConfig = viewer.getConfig();
                            lastHotspotCoords = {
                                pitch: viewConfig.pitch || 0,
                                yaw: viewConfig.yaw || 0
                            };
                        } else {
                            // Adjust current position
                            lastHotspotCoords.pitch += pitchAdj;
                            lastHotspotCoords.yaw += yawAdj;
                        }
                        
                        // Update visual and inputs
                        createTemporaryHotspot(lastHotspotCoords.pitch, lastHotspotCoords.yaw);
                    });
                });
            } else {
                // Just update the values
                updatePositionInputs(lastHotspotCoords.pitch, lastHotspotCoords.yaw);
            }
            
            // Add cancel/close handler
            form.onreset = () => {
                // Try to remove temporary hotspot
                try {
                    viewer.removeHotSpot('temp-placement-hotspot');
                } catch (e) {}
                
                // Exit placement mode
                isHotspotPlacementMode = false;
                const button = document.querySelector('[onclick="toggleHotspotPlacement()"]');
                if (button) {
                    button.classList.remove('bg-primary');
                    button.innerHTML = '<i class="fas fa-crosshairs"></i> Place Hotspot';
                }
            };
            
            // Reset to clear previous values except our new fields
            const name = document.getElementById('hotspotName');
            const target = document.getElementById('targetScene');
            if (name) name.value = '';
        }

        function hideAddHotspotDialog() {
            document.getElementById('hotspotDialog').classList.add('hidden');
        }

        // Modify handleAddHotspot to use the form values
        function handleAddHotspot(event) {
            event.preventDefault();

            if (!currentSceneId) {
                showToast('No scene selected', 'error');
                return;
            }

            // Get values from form
            const hotspotName = document.getElementById('hotspotName').value || 'Hotspot ' + Date.now();
            const targetSceneId = document.getElementById('targetScene').value;
            // Get coordinates from inputs (allows manual adjustment)
            const pitch = parseFloat(document.getElementById('hotspotPitch').value);
            const yaw = parseFloat(document.getElementById('hotspotYaw').value);
            
            if (!targetSceneId) {
                showToast('Please select a target scene', 'error');
                return;
            }
            
            if (isNaN(pitch) || isNaN(yaw)) {
                showToast('Invalid position coordinates', 'error');
                return;
            }
            
            // Show loading indicator
            const submitButton = event.target.querySelector('button[type="submit"]');
            if (submitButton) {
                submitButton.disabled = true;
                submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding...';
            }

            const formData = {
                hotspots: [{
                    name: hotspotName,
                    text: hotspotName,
                    type: 'navigation',
                    scene_id: currentSceneId,
                    target_scene_id: targetSceneId,
                    pitch: pitch,
                    yaw: yaw
                }]
            };

            console.log('Sending hotspot data:', formData);

            const url = `/agent/virtual-360/scenes/${currentSceneId}/hotspots`;
            console.log('Posting to URL:', url);

            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                    'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content
                },
                body: JSON.stringify(formData)
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        console.error('Server response:', text);
                        try {
                            const json = JSON.parse(text);
                            throw new Error(json.message || 'Failed to save hotspot');
                        } catch (e) {
                            throw new Error('Server error: ' + response.status);
                        }
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log('Hotspot save response:', data);
                
                if (data.success) {
                    hideAddHotspotDialog();
                    
                    // Try to remove any temporary hotspots
                    if (viewer) {
                        try {
                            const tempElements = document.querySelectorAll('.temp-placement-hotspot');
                            tempElements.forEach(el => {
                                const id = el.id;
                                if (id) viewer.removeHotSpot(id);
                            });
                        } catch (e) {}
                    }
                    
                    // Exit placement mode
                    isHotspotPlacementMode = false;
                    const button = document.querySelector('[onclick="toggleHotspotPlacement()"]');
                    if (button) {
                        button.classList.remove('bg-primary');
                        button.innerHTML = '<i class="fas fa-crosshairs"></i> Place Hotspot';
                    }
                    
                    // Setelah menambahkan hotspot, Reload hotspot dari server
                    showToast('Hotspot saved successfully, reloading...', 'success');
                    setTimeout(() => {
                        reloadHotspotsForScene(currentSceneId);
                    }, 500);
                    
                    lastHotspotCoords = null;
                } else {
                    throw new Error(data.message || 'Failed to save hotspot');
                }
            })
            .catch(error => {
                console.error('Error saving hotspot:', error);
                showToast(error.message, 'error');
            })
            .finally(() => {
                // Reset button state
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.innerHTML = 'Add Hotspot';
                }
            });
        }

        // Add CSS for the improved temporary hotspot
        document.addEventListener('DOMContentLoaded', function() {
            // Add style for temporary placement hotspot and debug points
            const style = document.createElement('style');
            style.textContent = `
                .temp-placement-hotspot {
                    background-color: rgba(255, 0, 0, 0.8) !important;
                    border: 3px dashed white !important;
                    animation: pulse 1.5s infinite;
                    width: 30px !important;
                    height: 30px !important;
                    margin-left: -15px !important;
                    margin-top: -15px !important;
                    z-index: 100 !important;
                    pointer-events: none !important;
                }
                
                .debug-point {
                    width: 2px !important;
                    height: 20px !important; 
                    background-color: lime !important;
                    margin-left: -1px !important;
                    margin-top: -10px !important;
                    z-index: 99 !important;
                    opacity: 0.8;
                    pointer-events: none !important;
                }
                
                .debug-point::before, .debug-point::after {
                    content: '';
                    position: absolute;
                    background-color: lime;
                }
                
                .debug-point::before {
                    width: 20px !important;
                    height: 2px !important;
                    left: -9px !important;
                    top: 9px !important;
                }
                
                @keyframes pulse {
                    0% { transform: scale(1); opacity: 1; }
                    50% { transform: scale(1.2); opacity: 0.8; }
                    100% { transform: scale(1); opacity: 1; }
                }
                
                .hotspot-tooltip {
                    background-color: rgba(0, 0, 0, 0.8);
                    color: white;
                    padding: 5px 10px;
                    border-radius: 4px;
                    font-size: 14px;
                    white-space: nowrap;
                    pointer-events: none;
                    z-index: 101;
                    position: absolute;
                    bottom: 100%;
                    left: 50%;
                    transform: translateX(-50%) translateY(-10px);
                    margin-bottom: 5px;
                }
            `;
            document.head.appendChild(style);
            
            // Add hotspot position helper
            const helper = document.createElement('div');
            helper.className = 'fixed bottom-16 right-4 bg-black bg-opacity-70 p-2 rounded text-white text-xs z-10';
            helper.innerHTML = `
                <div class="font-bold mb-1">Adsproperti: Panduan Posisi Hotspot:</div>
                <div class="flex flex-col space-y-1">
                    <div>1. Klik di scene untuk posisi tepat</div>
                    <div>2. Gunakan tombol untuk penyesuaian halus</div>
                    <div>3. Masukkan nilai manual jika diperlukan</div>
                    <div class="text-yellow-400 mt-1">Kursor mouse menunjukkan koordinat aktual</div>
                </div>
            `;
            helper.style.maxWidth = "250px";
            document.body.appendChild(helper);
            
            // Add toolbar button for debug markers
            const toolbar = document.querySelector('.viewer-controls');
            if (toolbar) {
                const debugButton = document.createElement('button');
                debugButton.className = 'control-button';
                debugButton.setAttribute('title', 'Toggle Debug Markers');
                debugButton.innerHTML = '<i class="fas fa-bullseye"></i>';
                debugButton.onclick = toggleDebugMarkers;
                toolbar.appendChild(debugButton);
            }
        });

        function loadHotspots(sceneId) {
            console.log('Loading hotspots for scene:', sceneId);
            
            if (!viewer || !sceneId) {
                console.error('Viewer not initialized or invalid scene ID');
                return;
            }

            const virtualTourId = getVirtualTourId();
            if (!virtualTourId) {
                console.error('Virtual Tour ID not found');
                return;
            }

            // Clear the hotspot list UI first
            const hotspotList = document.querySelector('.hotspot-list');
            if (hotspotList) {
                hotspotList.innerHTML = `
                    <div class="flex items-center justify-center p-4">
                        <div class="loading-spinner w-6 h-6 mr-2"></div>
                        <span>Loading hotspots...</span>
                    </div>
                `;
            }

            // Use direct URL without route helper to avoid issues
            const url = `/agent/virtual-360/scenes/${sceneId}/hotspots`;
            console.log('Fetching hotspots from:', url);

            // Set debugging information
            document.getElementById('debugStatus').textContent = `Status: Loading hotspots for scene ${sceneId}...`;

            // Use fetch with specific headers and debugging
            fetch(url, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                    'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content,
                    'Cache-Control': 'no-cache'
                }
            })
            .then(response => {
                console.log('Hotspot response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Received raw hotspot data for scene', sceneId, ':', data);
                
                if (!data.success) {
                    throw new Error(data.message || 'Server reported failure loading hotspots');
                }
                
                if (!data.hotspots || !Array.isArray(data.hotspots)) {
                    console.warn('No hotspots data received or invalid format for scene', sceneId);
                    updateHotspotList([], data.scenes || []);
                    return;
                }
                
                // Log each hotspot for debugging
                data.hotspots.forEach((hotspot, index) => {
                    console.log(`Hotspot ${index + 1}:`, {
                        id: hotspot.id,
                        name: hotspot.name,
                        type: hotspot.type,
                        scene_id: hotspot.scene_id,
                        target_scene_id: hotspot.target_scene_id,
                        pitch: hotspot.pitch,
                        yaw: hotspot.yaw
                    });
                });
                
                // Verify that we only have hotspots for this scene
                const filteredHotspots = data.hotspots.filter(h => h.scene_id == sceneId);
                if (filteredHotspots.length !== data.hotspots.length) {
                    console.warn(`Found ${data.hotspots.length} hotspots, but only ${filteredHotspots.length} belong to scene ${sceneId}`);
                }
                
                // Store hotspots data in a data attribute for the scene item
                const sceneItem = document.querySelector(`[data-scene-id="${sceneId}"]`);
                if (sceneItem) {
                    sceneItem.setAttribute('data-hotspots-count', filteredHotspots.length);
                    
                    // Update visual indicator
                    let hotspotCount = sceneItem.querySelector('.hotspot-count');
                    if (!hotspotCount) {
                        hotspotCount = document.createElement('span');
                        hotspotCount.className = 'hotspot-count px-1.5 py-0.5 text-xs bg-primary rounded-full text-white ml-2';
                        const sceneTitle = sceneItem.querySelector('.scene-item-title');
                        if (sceneTitle) {
                            sceneTitle.appendChild(hotspotCount);
                        }
                    }
                    hotspotCount.textContent = filteredHotspots.length;
                }

                // Clear existing hotspots in viewer
                try {
                    if (viewer && viewer.getConfig) {
                        const config = viewer.getConfig();
                        if (config.hotSpots) {
                            config.hotSpots.forEach(hotspot => {
                                try {
                                    viewer.removeHotSpot(hotspot.id);
                                } catch (e) {
                                    console.warn('Error removing hotspot:', e);
                                }
                            });
                        }
                    }
                } catch (e) {
                    console.warn('Error clearing hotspots:', e);
                }

                // Add new hotspots to viewer
                if (filteredHotspots.length > 0) {
                    filteredHotspots.forEach(hotspot => {
                        try {
                            if (!hotspot.pitch || !hotspot.yaw) {
                                console.error('Invalid hotspot coordinates:', hotspot);
                                return;
                            }
                            
                            console.log('Adding hotspot to viewer:', hotspot);
                            viewer.addHotSpot({
                                id: hotspot.id.toString(),
                                pitch: parseFloat(hotspot.pitch),
                                yaw: parseFloat(hotspot.yaw),
                                type: 'custom',
                                cssClass: `custom-hotspot ${hotspot.type}`,
                                createTooltipFunc: (divElement) => {
                                    divElement.innerHTML = `<div class="hotspot-tooltip">${hotspot.name || hotspot.text || 'Hotspot'}</div>`;
                                },
                                clickHandlerFunc: (e) => {
                                    if (hotspot.type === 'navigation' && hotspot.target_scene_id) {
                                        const targetSceneElement = document.querySelector(`[data-scene-id="${hotspot.target_scene_id}"]`);
                                        if (targetSceneElement) {
                                            const targetSceneUrl = targetSceneElement.dataset.sceneUrl;
                                            if (targetSceneUrl) {
                                                loadScene(targetSceneUrl);
                                            }
                                        }
                                    }
                                }
                            });
                        } catch (error) {
                            console.error('Error adding hotspot to viewer:', error, hotspot);
                        }
                    });
                }

                // Update hotspot list in the sidebar
                updateHotspotList(filteredHotspots, data.scenes || []);
                
                // Update debug status
                document.getElementById('debugStatus').textContent = `Status: Loaded ${filteredHotspots.length} hotspots for scene ${sceneId}`;
            })
            .catch(error => {
                console.error('Error loading hotspots:', error);
                showToast('Error loading hotspots: ' + error.message, 'error');
                document.getElementById('debugStatus').textContent = `Status: Error loading hotspots - ${error.message}`;
                
                // Clear hotspot list on error
                updateHotspotList([], []);
            });
        }

        // Enhanced function to update hotspot list
        function updateHotspotList(hotspots, scenes) {
            const hotspotList = document.querySelector('.hotspot-list');
            if (!hotspotList) {
                console.error('Hotspot list element not found');
                return;
            }

            if (!hotspots || hotspots.length === 0) {
                hotspotList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                        <div class="empty-state-title">No Hotspots Yet</div>
                        <div class="empty-state-description">
                            Add hotspots to connect scenes or provide information
                        </div>
                    </div>
                `;
                return;
            }

            console.log('Updating hotspot list with:', hotspots.length, 'hotspots');
            
            let hotspotHtml = '';
            hotspots.forEach(hotspot => {
                let targetSceneName = 'Unknown Scene';
                
                if (scenes && hotspot.target_scene_id) {
                    const targetScene = scenes.find(s => s.id == hotspot.target_scene_id);
                    if (targetScene) {
                        targetSceneName = targetScene.title;
                    }
                }
                
                hotspotHtml += `
                    <div class="hotspot-item" data-hotspot-id="${hotspot.id}" data-type="${hotspot.type}" data-target-scene-id="${hotspot.target_scene_id || ''}">
                        <div class="hotspot-item-info">
                            <div class="hotspot-item-title">${hotspot.name || hotspot.text || 'Unnamed Hotspot'}</div>
                            <div class="hotspot-item-type">
                                ${hotspot.type.charAt(0).toUpperCase() + hotspot.type.slice(1)}
                                ${hotspot.type === 'navigation' && hotspot.target_scene_id ? ` â ${targetSceneName}` : ''}
                            </div>
                        </div>
                        <div class="hotspot-item-actions">
                            <button class="hotspot-item-button edit" onclick="editHotspot(${hotspot.id})" title="Edit Hotspot">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="hotspot-item-button delete" onclick="deleteHotspot(${hotspot.id})" title="Delete Hotspot">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            });

            hotspotList.innerHTML = hotspotHtml;
            
            // Add timestamp data attribute to verify update
            hotspotList.setAttribute('data-last-updated', Date.now());
        }

        function editHotspot(hotspotId) {
            currentHotspotId = hotspotId;
            
            fetch(`{{ route('agent.virtual-360.scenes.hotspots', ['scene' => ':sceneId']) }}`.replace(':sceneId', currentSceneId), {
                headers: {
                    'X-CSRF-TOKEN': '{{ csrf_token() }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const hotspot = data.hotspots.find(h => h.id === hotspotId);
                    if (hotspot) {
                        document.getElementById('hotspotName').value = hotspot.name;
                        document.getElementById('targetScene').value = hotspot.target_scene_id || '';
                        document.getElementById('positionX').value = hotspot.position_x;
                        document.getElementById('positionY').value = hotspot.position_y;
                        document.getElementById('positionZ').value = hotspot.position_z;
                        
                        showAddHotspotDialog();
                    } else {
                        throw new Error('Hotspot not found');
                    }
                } else {
                    throw new Error(data.message || 'Failed to load hotspot');
                }
            })
            .catch(error => {
                showToast(error.message, 'error');
            });
        }

        function deleteHotspot(hotspotId) {
            if (!confirm('Are you sure you want to delete this hotspot?')) {
                return;
            }

            const virtualTourId = getVirtualTourId();
            if (!virtualTourId) {
                showToast('Virtual Tour ID not found', 'error');
                return;
            }

            // Show loading toast
            showToast('Deleting hotspot...', 'info');
            
            // Use correct route URL format - route is defined in agent prefix group
            const url = `/agent/${virtualTourId}/scenes/${currentSceneId}/hotspots/${hotspotId}`;
            console.log('Delete URL:', url);

            fetch(url, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                    'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content
                }
            })
            .then(response => {
                if (!response.ok) {
                    if (response.headers.get('content-type')?.includes('text/html')) {
                        throw new Error(`Server returned error: ${response.status} ${response.statusText}`);
                    }
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Use the direct reload function for better reliability
                    reloadHotspotsForScene(currentSceneId);
                    showToast('Hotspot deleted successfully', 'success');
                    
                    // Also remove hotspot from viewer if it exists
                    if (viewer) {
                        try {
                            viewer.removeHotSpot(hotspotId.toString());
                        } catch (e) {
                            console.warn('Error removing hotspot from viewer:', e);
                        }
                    }
                } else {
                    throw new Error(data.message || 'Failed to delete hotspot');
                }
            })
            .catch(error => {
                console.error('Error deleting hotspot:', error);
                showToast('Error deleting hotspot: ' + error.message, 'error');
                
                // If delete fails, reload hotspots to ensure UI is in sync
                setTimeout(() => {
                    reloadHotspotsForScene(currentSceneId);
                }, 1000);
            });
        }

        // Viewer control functions
        function toggleAutoRotate() {
            autoRotate = !autoRotate;
            viewer.setAutoRotate(autoRotate);
            const button = document.querySelector('[onclick="toggleAutoRotate()"]');
            button.classList.toggle('bg-primary', autoRotate);
        }

        function toggleFullscreen() {
            if (viewer.getContainer().requestFullscreen) {
                viewer.getContainer().requestFullscreen();
            } else if (viewer.getContainer().webkitRequestFullscreen) {
                viewer.getContainer().webkitRequestFullscreen();
            } else if (viewer.getContainer().msRequestFullscreen) {
                viewer.getContainer().msRequestFullscreen();
            }
        }

        function toggleGyroscope() {
            gyroscopeEnabled = !gyroscopeEnabled;
            viewer.setOrientation(gyroscopeEnabled);
            const button = document.querySelector('[onclick="toggleGyroscope()"]');
            button.classList.toggle('bg-primary', gyroscopeEnabled);
        }

        function resetView() {
            viewer.setHfov(100);
            viewer.setPitch(0);
            viewer.setYaw(0);
        }

        function reloadScene() {
            viewer.reload();
        }

        // Add save button event listener
        document.getElementById('saveBtn').addEventListener('click', saveChanges);

        // Save changes function
        async function saveChanges() {
            try {
                const virtualTourId = getVirtualTourId();
                if (!virtualTourId) {
                    showToast('Virtual Tour ID not found', 'error');
                    return;
                }

                // Show loading state
                const saveBtn = document.getElementById('saveBtn');
                if (saveBtn) {
                    saveBtn.disabled = true;
                    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                }

                // Get all scenes and their hotspots
                const scenes = Array.from(document.querySelectorAll('.scene-item')).map(sceneItem => {
                    const sceneId = parseInt(sceneItem.dataset.sceneId);
                    const title = sceneItem.querySelector('.scene-item-title').textContent;

                    // Get hotspots that belong to this scene
                    const hotspots = Array.from(sceneItem.querySelectorAll('.hotspot-item')).map(hotspotItem => {
                        const hotspotConfig = viewer?.getConfig().hotSpots?.find(
                            h => h.id === hotspotItem.dataset.hotspotId
                        );
                        const targetSceneElement = hotspotItem.querySelector('.target-scene');
                        const type = hotspotItem.querySelector('.hotspot-type').textContent.toLowerCase();
                        
                        const hotspotData = {
                            id: parseInt(hotspotItem.dataset.hotspotId),
                            name: hotspotItem.querySelector('.hotspot-item-title').textContent,
                            type: type,
                            scene_id: sceneId,
                            pitch: hotspotConfig ? parseFloat(hotspotConfig.pitch) : 0,
                            yaw: hotspotConfig ? parseFloat(hotspotConfig.yaw) : 0
                        };

                        // Only add target_scene_id for navigation hotspots
                        if (type === 'navigation' && targetSceneElement) {
                            hotspotData.target_scene_id = parseInt(targetSceneElement.dataset.sceneId);
                        }

                        return hotspotData;
                    });

                    return {
                        id: sceneId,
                        title: title,
                        hotspots: hotspots
                    };
                });

                // Prepare save data
                const saveData = {
                    virtual_tour_id: parseInt(virtualTourId),
                    scenes: scenes // Include all scenes in the data
                };

                console.log('Saving data:', saveData); // Debug log

                const response = await fetch(`/agent/virtual-360/${virtualTourId}/save`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content
                    },
                    body: JSON.stringify(saveData)
                });

                const data = await response.json();
                
                if (!response.ok) {
                    console.error('Server response:', data);
                    throw new Error(data.message || 'Failed to save changes');
                }

                if (data.success) {
                    showToast('Changes saved successfully', 'success');
                } else {
                    throw new Error(data.message || 'Failed to save changes');
                }
            } catch (error) {
                console.error('Error saving changes:', error);
                showToast('Error saving changes: ' + error.message, 'error');
            } finally {
                // Reset save button state
                const saveBtn = document.getElementById('saveBtn');
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = '<i class="fas fa-save"></i> Save Changes';
                }
            }
        }

        // Add auto-save functionality (optional)
        let autoSaveTimeout;
        function scheduleAutoSave() {
            clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(() => {
                saveChanges();
            }, 30000); // Auto-save every 30 seconds
        }

        // Add event listeners for changes that should trigger auto-save
        document.addEventListener('change', scheduleAutoSave);
        document.addEventListener('input', scheduleAutoSave);

        // Add these functions at the end of your JavaScript section
        function toggleHotspotDebug() {
            const panel = document.getElementById('hotspotDebugPanel');
            if (panel) {
                panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            }
        }

        function debugHotspots() {
            const panel = document.getElementById('hotspotDebugPanel');
            const content = document.getElementById('hotspotDebugContent');
            
            if (!panel || !content) return;
            
            // Show the panel
            panel.style.display = 'block';
            
            // Get hotspot data for the current scene
            if (!currentSceneId) {
                content.innerHTML = '<div class="text-red-500">No current scene selected</div>';
                return;
            }
            
            content.innerHTML = '<div>Loading hotspot data...</div>';
            
            fetch(`/agent/virtual-360/scenes/${currentSceneId}/hotspots`, {
                headers: {
                    'Accept': 'application/json',
                    'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content
                }
            })
            .then(response => response.json())
            .then(data => {
                console.log('Debug hotspot data:', data);
                
                if (!data.success) {
                    content.innerHTML = `<div class="text-red-500">Error: ${data.message || 'Unknown error'}</div>`;
                    return;
                }
                
                if (!data.hotspots || data.hotspots.length === 0) {
                    content.innerHTML = `<div class="text-yellow-500">No hotspots found for scene ${currentSceneId}</div>`;
                    return;
                }
                
                // Display hotspot info
                let html = `<div class="mb-2">Scene ID: ${currentSceneId} | ${data.hotspots.length} hotspots</div>`;
                
                data.hotspots.forEach((hotspot, index) => {
                    html += `
                        <div class="border border-gray-700 p-2 mb-2 rounded">
                            <div class="font-bold">${index + 1}. ${hotspot.name || 'Unnamed'} (ID: ${hotspot.id})</div>
                            <div>Type: ${hotspot.type}</div>
                            <div>Coordinates: pitch=${hotspot.pitch}, yaw=${hotspot.yaw}</div>
                            ${hotspot.type === 'navigation' ? `<div>Target Scene: ${hotspot.target_scene_id || 'None'}</div>` : ''}
                        </div>
                    `;
                });
                
                content.innerHTML = html;
                
                // Check if hotspots are in the viewer
                if (viewer) {
                    const config = viewer.getConfig();
                    if (config.hotSpots) {
                        html += `<div class="mt-2 font-bold">Hotspots in viewer: ${config.hotSpots.length}</div>`;
                        config.hotSpots.forEach((h, i) => {
                            html += `<div>${i + 1}. ID: ${h.id}, pitch: ${h.pitch}, yaw: ${h.yaw}</div>`;
                        });
                    }
                }
            })
            .catch(error => {
                content.innerHTML = `<div class="text-red-500">Error: ${error.message}</div>`;
            });
        }

        // Add debug button to toolbar
        document.addEventListener('DOMContentLoaded', function() {
            const toolbar = document.querySelector('.viewer-controls');
            if (toolbar) {
                const debugButton = document.createElement('button');
                debugButton.className = 'control-button';
                debugButton.setAttribute('title', 'Debug Hotspots');
                debugButton.innerHTML = '<i class="fas fa-bug"></i>';
                debugButton.onclick = debugHotspots;
                toolbar.appendChild(debugButton);
            }
        });

        // SOLUSI LANGSUNG UNTUK MASALAH HOTSPOT TIDAK TAMPIL

        // Fungsi untuk memuat ulang seluruh hotspot untuk scene tertentu secara langsung 
        function reloadHotspotsForScene(sceneId) {
            console.log('DIRECT RELOAD HOTSPOTS for scene:', sceneId);
            
            // Reset viewer jika ada
            if (viewer) {
                try {
                    // Hapus semua hotspot yang ada
                    const config = viewer.getConfig();
                    if (config.hotSpots) {
                        config.hotSpots.forEach(hotspot => {
                            try {
                                viewer.removeHotSpot(hotspot.id);
                            } catch (e) {
                                console.warn('Error removing hotspot:', e);
                            }
                        });
                    }
                } catch (e) {
                    console.warn('Error clearing viewer:', e);
                }
            } else {
                console.error('Viewer not initialized, cannot load hotspots');
                showToast('Error: Viewer not initialized', 'error');
                return;
            }
            
            document.getElementById('debugStatus').textContent = `Status: Force loading hotspots for scene ${sceneId}...`;
            
            fetch(`/agent/virtual-360/scenes/${sceneId}/hotspots?nocache=${Date.now()}`, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                    'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content,
                    'Cache-Control': 'no-cache, no-store, must-revalidate',
                    'Pragma': 'no-cache',
                    'Expires': '0'
                }
            })
            .then(response => {
                console.log('Raw response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Raw hotspot data received:', data);
                
                // Verifikasi response valid
                if (!data.success) {
                    throw new Error('Server returned error: ' + (data.message || 'Unknown error'));
                }
                
                if (!data.hotspots || !Array.isArray(data.hotspots)) {
                    console.warn(`No hotspots found for scene ${sceneId}`);
                    // Clear hotspot list
                    const hotspotList = document.querySelector('.hotspot-list');
                    if (hotspotList) {
                        hotspotList.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-state-icon"><i class="fas fa-map-marker-alt"></i></div>
                                <div class="empty-state-title">No Hotspots Found</div>
                                <div class="empty-state-description">No hotspots for this scene in database</div>
                            </div>
                        `;
                    }
                    return;
                }
                
                // Log data untuk debugging
                console.log(`Found ${data.hotspots.length} hotspots for scene ${sceneId}:`, data.hotspots);
                
                // Tambahkan hotspot ke viewer
                data.hotspots.forEach(hotspot => {
                    if (!hotspot.pitch || !hotspot.yaw) {
                        console.error('Invalid hotspot coordinates:', hotspot);
                        return;
                    }
                    
                    try {
                        console.log(`Adding hotspot to viewer: ID=${hotspot.id}, Type=${hotspot.type}, Pitch=${hotspot.pitch}, Yaw=${hotspot.yaw}`);
                        
                        viewer.addHotSpot({
                            id: hotspot.id.toString(),
                            pitch: parseFloat(hotspot.pitch),
                            yaw: parseFloat(hotspot.yaw),
                            type: 'custom',
                            cssClass: `custom-hotspot ${hotspot.type}`,
                            createTooltipFunc: (divElement) => {
                                divElement.innerHTML = `<div class="hotspot-tooltip">${hotspot.name || hotspot.text || 'Hotspot'}</div>`;
                            },
                            clickHandlerFunc: (e) => {
                                if (hotspot.type === 'navigation' && hotspot.target_scene_id) {
                                    const targetSceneElement = document.querySelector(`[data-scene-id="${hotspot.target_scene_id}"]`);
                                    if (targetSceneElement) {
                                        const targetSceneUrl = targetSceneElement.dataset.sceneUrl;
                                        if (targetSceneUrl) {
                                            loadScene(targetSceneUrl);
                                        }
                                    }
                                }
                            }
                        });
                    } catch (error) {
                        console.error(`Error adding hotspot ID=${hotspot.id}:`, error);
                    }
                });
                
                // Update hotspot list di sidebar
                const hotspotList = document.querySelector('.hotspot-list');
                if (hotspotList) {
                    if (data.hotspots.length === 0) {
                        hotspotList.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-state-icon"><i class="fas fa-map-marker-alt"></i></div>
                                <div class="empty-state-title">No Hotspots</div>
                                <div class="empty-state-description">Add hotspots to connect scenes or provide information</div>
                            </div>
                        `;
                    } else {
                        let html = '';
                        
                        data.hotspots.forEach(hotspot => {
                            let targetSceneName = '';
                            if (hotspot.type === 'navigation' && hotspot.target_scene_id && data.scenes) {
                                const targetScene = data.scenes.find(s => s.id == hotspot.target_scene_id);
                                targetSceneName = targetScene ? targetScene.title : 'Unknown Scene';
                            }
                            
                            html += `
                                <div class="hotspot-item" data-hotspot-id="${hotspot.id}" data-type="${hotspot.type}" data-target-scene-id="${hotspot.target_scene_id || ''}">
                                    <div class="hotspot-item-info">
                                        <div class="hotspot-item-title">${hotspot.name || hotspot.text || 'Unnamed Hotspot'}</div>
                                        <div class="hotspot-item-type">
                                            ${hotspot.type.charAt(0).toUpperCase() + hotspot.type.slice(1)}
                                            ${targetSceneName ? ` â ${targetSceneName}` : ''}
                                        </div>
                                    </div>
                                    <div class="hotspot-item-actions">
                                        <button class="hotspot-item-button edit" onclick="editHotspot(${hotspot.id})" title="Edit Hotspot">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="hotspot-item-button delete" onclick="deleteHotspot(${hotspot.id})" title="Delete Hotspot">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            `;
                        });
                        
                        hotspotList.innerHTML = html;
                    }
                }
                
                // Update debug info
                document.getElementById('debugStatus').textContent = `Status: Loaded ${data.hotspots.length} hotspots for scene ${sceneId}`;
                
                // Tampilkan toast sukses
                showToast(`Loaded ${data.hotspots.length} hotspots for scene ${sceneId}`, 'success');
            })
            .catch(error => {
                console.error('ERROR LOADING HOTSPOTS:', error);
                document.getElementById('debugStatus').textContent = `Status: Error loading hotspots - ${error.message}`;
                
                // Tampilkan error di UI
                showToast('Error loading hotspots: ' + error.message, 'error');
                
                // Clear hotspot list
                const hotspotList = document.querySelector('.hotspot-list');
                if (hotspotList) {
                    hotspotList.innerHTML = `
                        <div class="p-4 bg-red-900 text-white rounded-lg mb-4">
                            <div class="font-bold">Error Loading Hotspots</div>
                            <div class="text-sm">${error.message}</div>
                        </div>
                        <div class="empty-state">
                            <div class="empty-state-icon text-red-500"><i class="fas fa-exclamation-triangle"></i></div>
                            <div class="empty-state-title">Error Loading Hotspots</div>
                            <div class="empty-state-description">Failed to load hotspots from server</div>
                        </div>
                    `;
                }
            });
        }
        
        // Tambahkan tombol Force Reload di toolbar
        document.addEventListener('DOMContentLoaded', function() {
            const toolbar = document.querySelector('.viewer-controls');
            if (toolbar) {
                const reloadButton = document.createElement('button');
                reloadButton.className = 'control-button';
                reloadButton.setAttribute('title', 'Force Reload Hotspots');
                reloadButton.innerHTML = '<i class="fas fa-sync-alt"></i>';
                reloadButton.onclick = function() {
                    if (currentSceneId) {
                        reloadHotspotsForScene(currentSceneId);
                    } else {
                        showToast('No scene selected', 'error');
                    }
                };
                toolbar.appendChild(reloadButton);
            }
        });
        
        // Override fungsi loadScene untuk menggunakan reloadHotspotsForScene
        const originalLoadScene = loadScene;
        loadScene = function(sceneUrl) {
            console.log('OVERRIDE: Loading scene with URL:', sceneUrl);
            
            const loadingElement = document.getElementById('loading');
            if (loadingElement) {
                loadingElement.classList.remove('hidden');
            }
            document.getElementById('debugStatus').textContent = 'Status: Loading scene...';
            
            try {
                // Get scene item data
                const sceneItem = Array.from(document.querySelectorAll('.scene-item'))
                    .find(item => item.dataset.sceneUrl === sceneUrl);
                
                if (!sceneItem) {
                    console.error('Scene not found in DOM with URL:', sceneUrl);
                    document.getElementById('debugStatus').textContent = 'Status: Error - Scene not found in sidebar';
                    showToast('Scene berhasil diupload, tapi tidak ditemukan di sidebar. Refresh halaman jika diperlukan.', 'warning');
                    
                    // Jangan lempar error agar proses tetap berjalan, khususnya setelah upload scene baru
                    if (loadingElement) {
                        loadingElement.classList.add('hidden');
                    }
                    return;
                }

                // Update active scene in sidebar
                document.querySelectorAll('.scene-item').forEach(item => {
                    item.classList.toggle('active', item.dataset.sceneUrl === sceneUrl);
                });

                // Store previous scene ID before changing
                const previousSceneId = currentSceneId;
                
                // Update current scene ID
                currentSceneId = sceneItem.dataset.sceneId;
                console.log('Switching from scene', previousSceneId, 'to scene ID:', currentSceneId);

                // Update scene title in viewer header
                const sceneTitle = sceneItem.querySelector('.scene-item-title').textContent;
                document.querySelector('.viewer-header h2').textContent = sceneTitle;

                // Clear existing viewer and hotspots before changing scenes
                if (viewer) {
                    try {
                        // Destroy the old viewer to ensure clean state
                        viewer.destroy();
                        viewer = null;
                    } catch (e) {
                        console.warn('Error destroying viewer:', e);
                    }
                }

                // Create new viewer instance
                viewer = pannellum.viewer('viewer', {
                    type: 'equirectangular',
                    panorama: sceneUrl,
                    autoLoad: true,
                    autoRotate: autoRotate,
                    compass: true,
                    mouseZoom: true,
                    preview: '',
                    hotSpots: [], // Start with empty hotspots
                    hfov: 100,
                    minHfov: 50,
                    maxHfov: 120,
                    showZoomCtrl: true,
                    showFullscreenCtrl: true,
                    orientationOnByDefault: gyroscopeEnabled,
                    onLoad: function() {
                        console.log('Scene loaded successfully, now loading hotspots');
                        
                        if (loadingElement) {
                            loadingElement.classList.add('hidden');
                        }
                        
                        // Directly load hotspots after scene is loaded
                        if (currentSceneId) {
                            // Use our direct reload hotspots function
                            setTimeout(() => {
                                reloadHotspotsForScene(currentSceneId);
                            }, 500);
                        }
                        
                        showToast('Scene loaded successfully', 'success');
                    },
                    onError: function(err) {
                        console.error('Error loading scene:', err);
                        if (loadingElement) {
                            loadingElement.classList.add('hidden');
                        }
                        document.getElementById('debugStatus').textContent = 'Status: Error - ' + err;
                        showToast('Error loading scene: ' + err, 'error');
                    }
                });

            } catch (error) {
                console.error('Error in loadScene:', error);
                if (loadingElement) {
                    loadingElement.classList.add('hidden');
                }
                document.getElementById('debugStatus').textContent = 'Status: Error - ' + error.message;
                showToast('Error loading scene: ' + error.message, 'error');
            }
        };
        
        // Panggil reload hotspots pada startup untuk scene pertama
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                const firstSceneItem = document.querySelector('.scene-item');
                if (firstSceneItem) {
                    const firstSceneId = firstSceneItem.dataset.sceneId;
                    if (firstSceneId && viewer) {
                        console.log('Loading hotspots for first scene:', firstSceneId);
                        reloadHotspotsForScene(firstSceneId);
                    }
                }
            }, 2000); // Tunggu 2 detik untuk memastikan viewer siap
        });

        // Hapus kondisi di template untuk opsi target scene agar semua scene muncul
        document.addEventListener('DOMContentLoaded', function() {
            // 1. Update template dialog
            const hotspotDialog = document.getElementById('hotspotDialog');
            if (hotspotDialog) {
                const targetSceneSelect = hotspotDialog.querySelector('#targetScene');
                if (targetSceneSelect) {
                    // Mengisi opsi target scene
                    updateTargetSceneOptions(targetSceneSelect);
                }
            }

            // 2. Tambahkan fungsi untuk memperbarui daftar target scene
            document.querySelector('.scene-list').addEventListener('DOMSubtreeModified', function() {
                const targetSceneSelect = document.getElementById('targetScene');
                if (targetSceneSelect) {
                    updateTargetSceneOptions(targetSceneSelect);
                }
            });
        });

        // Fungsi untuk mengupdate opsi target scene
        function updateTargetSceneOptions(selectElement) {
            if (!selectElement) return;
            
            // Simpan nilai yang dipilih saat ini (jika ada)
            const currentValue = selectElement.value;
            
            // Kosongkan opsi yang ada
            selectElement.innerHTML = '<option value="">Select a target scene</option>';
            
            // Ambil semua scene
            const scenes = document.querySelectorAll('.scene-item');
            const currentSceneId = document.querySelector('.scene-item.active')?.dataset.sceneId;
            
            // Tambahkan semua scene kecuali scene yang aktif saat ini
            scenes.forEach(scene => {
                const sceneId = scene.dataset.sceneId;
                const title = scene.querySelector('.scene-item-title')?.textContent || 'Unnamed Scene';
                
                // Tidak menambahkan scene aktif sebagai target
                if (sceneId !== currentSceneId) {
                    const option = document.createElement('option');
                    option.value = sceneId;
                    option.textContent = title;
                    selectElement.appendChild(option);
                }
            });
            
            // Kembalikan nilai yang dipilih sebelumnya jika masih valid
            if (currentValue) {
                for (let i = 0; i < selectElement.options.length; i++) {
                    if (selectElement.options[i].value === currentValue) {
                        selectElement.selectedIndex = i;
                        break;
                    }
                }
            }
            
            // Log jumlah opsi yang ditambahkan untuk debugging
            console.log(`Updated target scene options: ${selectElement.options.length - 1} scenes available`);
        }

        // Export functionality
        function showExportDialog() {
            document.getElementById('exportDialog').classList.remove('hidden');
        }

        function closeExportDialog() {
            document.getElementById('exportDialog').classList.add('hidden');
        }

        // Start export function
        async function startExport() {
            try {
                // Show loading state
                document.getElementById('exportContent').classList.add('hidden');
                document.getElementById('exportLoading').classList.remove('hidden');

                // Get export options
                const includeViewer = document.getElementById('includeViewer').checked;
                const includePWA = document.getElementById('includePWA').checked;

                // Get virtual tour ID
                const tourId = getVirtualTourId();
                if (!tourId) {
                    throw new Error('Virtual Tour ID not found');
                }

                // Collect scenes data
                const scenes = Array.from(document.querySelectorAll('.scene-item')).map(scene => ({
                    id: scene.dataset.sceneId,
                    title: scene.querySelector('.scene-item-title').textContent,
                    url: scene.dataset.sceneUrl
                }));

                // Prepare form data
                const formData = new FormData();
                formData.append('tourId', tourId);
                formData.append('includeViewer', includeViewer);
                formData.append('includePWA', includePWA);
                formData.append('scenes', JSON.stringify(scenes));

                // Add CSRF token
                const token = document.querySelector('meta[name="csrf-token"]').content;
                
                // Perform export
                const response = await fetch(`/agent/virtual-360/${tourId}/export`, {
                    method: 'POST',
                    headers: {
                        'X-CSRF-TOKEN': token,
                        'Accept': 'application/json'
                    },
                    body: formData
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Export failed');
                }

                // Get blob from response
                const blob = await response.blob();
                
                // Create download link
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `virtual-tour-${tourId}.zip`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();

                // Show success message
                showToast('Virtual tour exported successfully!', 'success');
                
                // Close dialog
                closeExportDialog();

            } catch (error) {
                console.error('Export error:', error);
                
                // Show error in dialog if possible
                const errorElement = document.getElementById('exportError');
                if (errorElement) {
                    errorElement.querySelector('p').textContent = error.message || 'Export failed';
                    errorElement.classList.remove('hidden');
                    document.getElementById('exportContent').classList.remove('hidden');
                    document.getElementById('exportLoading').classList.add('hidden');
                } else {
                    // Fallback to toast
                    showToast(error.message || 'Export failed', 'error');
                }
            } finally {
                // Reset dialog state if not showing error in dialog
                if (document.getElementById('exportError')?.classList.contains('hidden')) {
                    document.getElementById('exportContent').classList.remove('hidden');
                    document.getElementById('exportLoading').classList.add('hidden');
                }
            }
        }

        function closeExportDialog() {
            document.getElementById('exportDialog').classList.add('hidden');
            document.getElementById('exportContent').classList.remove('hidden');
            document.getElementById('exportLoading').classList.add('hidden');
            
            // Hide error message if shown
            const errorElement = document.getElementById('exportError');
            if (errorElement) {
                errorElement.classList.add('hidden');
            }
        }

        // ... existing code ...

        // Scene checking functions
        function hasScenesToExport() {
            const scenes = document.querySelectorAll('.scene-item');
            return scenes && scenes.length > 0;
        }

        function getScenesToExport() {
            const scenes = [];
            document.querySelectorAll('.scene-item').forEach(scene => {
                scenes.push({
                    id: parseInt(scene.dataset.sceneId),
                    title: scene.querySelector('.scene-item-title').textContent,
                    imageUrl: scene.dataset.sceneUrl
                });
            });
            return scenes;
        }

        // Export functions
        async function exportTour() {
            try {
                // Check if there are scenes to export
                const scenes = document.querySelectorAll('.scene-item');
                if (!scenes || scenes.length === 0) {
                    showToast('No scenes available to export', 'error');
                    return;
                }

                // Show export dialog
                document.getElementById('exportDialog').classList.remove('hidden');
                
            } catch (error) {
                console.error('Error preparing export:', error);
                showToast('Error preparing export', 'error');
            }
        }

        // ... existing code ...
    </script>
</body>
</html>
